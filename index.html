<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compliance Readiness Checker</title>
  <style>
    :root {
      color-scheme: light dark;
      --font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      --space-1: 0.5rem;
      --space-2: 1rem;
      --space-3: 1.5rem;
      --space-4: 2rem;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-sm: 0 2px 6px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 10px 30px rgba(15, 23, 42, 0.12);
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .app[data-theme="light"] {
      --color-bg: #f5f7fa;
      --color-surface: #ffffff;
      --color-text: #1f2933;
      --color-muted: #52606d;
      --color-border: #d9e2ec;
      --color-accent: #2f80ed;
      --color-accent-soft: rgba(47, 128, 237, 0.15);
      --color-success: #2d9d78;
      --color-warning: #f2c94c;
      --color-danger: #e15554;
      --color-high: #e15554;
      --color-medium: #f2994a;
      --color-low: #2f80ed;
      --color-card-shadow: rgba(15, 23, 42, 0.12);
    }

    .app[data-theme="dark"] {
      --color-bg: #12161d;
      --color-surface: #1b212c;
      --color-text: #f2f5f9;
      --color-muted: #9aa5b1;
      --color-border: #2b3442;
      --color-accent: #4c9aff;
      --color-accent-soft: rgba(76, 154, 255, 0.15);
      --color-success: #28c876;
      --color-warning: #f2c94c;
      --color-danger: #ff6b6b;
      --color-high: #ff6b6b;
      --color-medium: #f2c94c;
      --color-low: #4c9aff;
      --color-card-shadow: rgba(0, 0, 0, 0.45);
    }

    .sidebar {
      background: linear-gradient(180deg, rgba(47, 128, 237, 0.08), rgba(47, 128, 237, 0));
      border-right: 1px solid var(--color-border);
      padding: var(--space-3);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-1);
    }

    .toggle-theme {
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .toggle-theme:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .sidebar-card {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-2);
    }

    .progress-summary {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: var(--space-1);
      margin-bottom: var(--space-1);
      font-weight: 600;
    }

    .progress-bar {
      height: 10px;
      background: rgba(47, 128, 237, 0.15);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar span {
      display: block;
      height: 100%;
      width: 0;
      background: var(--color-accent);
      transition: width 0.3s ease;
    }

    nav h3 {
      margin: 0 0 var(--space-1) 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-muted);
    }

    .nav-group {
      margin-bottom: var(--space-2);
    }

    .nav-items {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .nav-link {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      padding: 0.55rem 0.75rem;
      color: var(--color-text);
      cursor: pointer;
      font-size: 0.95rem;
      text-align: left;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
    }

    .nav-link:hover,
    .nav-link:focus-visible {
      background: var(--color-accent-soft);
      border-color: var(--color-accent);
      outline: none;
      transform: translateY(-1px);
    }

    .nav-link.complete {
      border-color: var(--color-success);
      background: rgba(45, 157, 120, 0.12);
    }

    .domain-count {
      font-size: 0.85rem;
      color: var(--color-muted);
      font-weight: 600;
    }

    .sidebar-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    main {
      padding: var(--space-3);
      background: var(--color-bg);
      overflow-y: auto;
    }

    .app-header {
      background: var(--color-surface);
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.75rem;
    }

    .app-header p {
      margin: 0;
      color: var(--color-muted);
      line-height: 1.5;
    }

    .disclaimer-badge {
      align-self: flex-start;
      background: rgba(241, 149, 45, 0.15);
      color: #b4690e;
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .app[data-theme="dark"] .disclaimer-badge {
      color: #f2c94c;
      background: rgba(242, 201, 76, 0.2);
    }

    .card {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-2);
    }

    .card + .card {
      margin-top: var(--space-2);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .domain-section {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: var(--space-3);
    }

    .domain-header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: var(--space-2);
    }

    .domain-header h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .domain-intro {
      margin: 0;
      color: var(--color-muted);
      font-size: 0.95rem;
    }

    fieldset.question-block {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      margin: 0;
      background: rgba(47, 128, 237, 0.02);
      transition: border 0.2s ease;
    }

    fieldset.question-block:focus-within {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 2px var(--color-accent-soft);
    }

    fieldset.question-block.has-error {
      border-color: var(--color-danger);
    }

    fieldset legend {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: var(--space-1);
    }

    .info-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .info-trigger {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
    }

    .info-trigger:hover,
    .info-trigger:focus-visible {
      background: var(--color-accent);
      color: #ffffff;
      border-color: var(--color-accent);
      transform: translateY(-1px);
      outline: none;
    }

    .tooltip {
      position: absolute;
      top: 130%;
      right: 0;
      width: min(320px, 70vw);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
      box-shadow: var(--shadow-md);
      color: var(--color-text);
      font-size: 0.9rem;
      line-height: 1.45;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10;
    }

    .info-wrapper:hover .tooltip,
    .info-wrapper:focus-within .tooltip {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .option {
      position: relative;
    }

    .option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .option label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.55rem 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }

    .option label:hover {
      transform: translateY(-1px);
    }

    .option input[type="radio"]:checked + label {
      border-color: var(--color-accent);
      background: var(--color-accent-soft);
      font-weight: 600;
    }

    .error-message {
      margin: 0.75rem 0 0 0;
      color: var(--color-danger);
      font-size: 0.9rem;
    }

    .questionnaire-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: var(--space-2);
    }

    .btn {
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      padding: 0.65rem 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .btn-primary {
      background: var(--color-accent);
      color: #ffffff;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover,
    .btn-primary:focus-visible {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      outline: none;
    }

    .btn-outline {
      background: transparent;
      border-color: var(--color-border);
      color: var(--color-text);
    }

    .btn-outline:hover,
    .btn-outline:focus-visible {
      border-color: var(--color-accent);
      color: var(--color-accent);
      outline: none;
    }

    .status-region {
      margin-top: 0.5rem;
      min-height: 1.2rem;
      color: var(--color-success);
      font-size: 0.9rem;
    }

    .results-grid {
      display: grid;
      gap: var(--space-2);
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .score-card {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .score-card .score-info {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .score-value {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .score-label {
      font-size: 0.95rem;
      color: var(--color-muted);
    }

    .donut {
      width: 110px;
      height: 110px;
    }

    .donut text {
      font-size: 1rem;
      font-weight: 600;
      fill: var(--color-text);
    }

    .domain-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--space-2);
    }

    .domain-table th,
    .domain-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--color-border);
      text-align: left;
    }

    .domain-table th {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-muted);
    }

    .bar {
      background: rgba(47, 128, 237, 0.12);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }

    .bar span {
      display: block;
      height: 100%;
      border-radius: inherit;
    }

    .severity-section {
      margin-top: var(--space-3);
    }

    .severity-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      margin-bottom: var(--space-1);
    }

    .severity-tag {
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .severity-tag.high { background: rgba(225, 85, 84, 0.2); color: var(--color-high); }
    .severity-tag.medium { background: rgba(242, 153, 74, 0.25); color: var(--color-medium); }
    .severity-tag.low { background: rgba(47, 128, 237, 0.18); color: var(--color-low); }

    details.finding {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      box-shadow: var(--shadow-sm);
    }

    details.finding summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    details.finding summary::-webkit-details-marker {
      display: none;
    }

    .finding-meta {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .finding-body {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.75rem;
    }

    .finding-body ul {
      margin: 0;
      padding-left: 1.2rem;
    }

    .results-actions {
      margin-top: var(--space-2);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(47, 128, 237, 0.12);
      color: var(--color-text);
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .list-card ul {
      margin: 0;
      padding-left: 1.2rem;
      display: grid;
      gap: 0.4rem;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 980px) {
      .app {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: sticky;
        top: 0;
        z-index: 20;
        border-right: none;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg);
      }
    }

    @media (max-width: 720px) {
      .app-header {
        padding: var(--space-2);
      }

      .domain-section {
        padding: var(--space-2);
      }

      .score-card {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media print {
      body {
        background: #ffffff;
        color: #000000;
      }

      .sidebar,
      .app-header,
      .questionnaire-actions,
      .sidebar-card,
      .sidebar-actions,
      .toggle-theme,
      .results-actions button,
      .nav-group,
      .status-region {
        display: none !important;
      }

      main {
        padding: 0;
      }

      .app {
        display: block;
      }

      .results-view {
        display: block !important;
      }

      details.finding {
        border: 1px solid #cccccc;
        box-shadow: none;
      }
    }

    button:focus-visible,
    [role="button"]:focus-visible,
    summary:focus-visible,
    .nav-link:focus-visible {
      outline: 3px solid var(--color-accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="app" data-theme="light" id="appRoot">
    <aside class="sidebar" aria-label="Assessment navigation">
      <div class="sidebar-header">
        <h2 class="sr-only">Interface controls</h2>
        <span class="pill" aria-live="polite" id="saveStateLabel">Ready</span>
        <button type="button" class="toggle-theme" id="themeToggle" aria-pressed="false">Toggle theme</button>
      </div>
      <div class="sidebar-card" aria-live="polite">
        <div class="progress-summary">
          <span id="progressCount">0 / 0 answered</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar" aria-hidden="true">
          <span id="progressBar"></span>
        </div>
      </div>
      <nav aria-label="Questionnaire sections" id="domainNav"></nav>
      <div class="sidebar-actions">
        <button type="button" class="btn btn-outline" id="saveProgressBtn">💾 Save progress</button>
        <button type="button" class="btn btn-outline" id="clearProgressBtn">🧹 Clear answers</button>
      </div>
    </aside>
    <main id="mainContent" tabindex="-1">
      <header class="app-header">
        <h1 id="appTitle">Compliance Readiness Checker</h1>
        <p id="appDescription">Assess your organization&apos;s readiness for HIPAA and GDPR with a guided, evidence-friendly questionnaire.</p>
        <span class="disclaimer-badge" id="disclaimerBadge">Guidance only &mdash; not legal advice</span>
      </header>
      <section id="questionnaireView" aria-labelledby="questionnaireHeading">
        <h2 class="sr-only" id="questionnaireHeading">Compliance questionnaire</h2>
        <form id="questionnaireForm" novalidate></form>
        <div class="questionnaire-actions">
          <button type="submit" form="questionnaireForm" class="btn btn-primary">Submit responses</button>
          <button type="button" class="btn btn-outline" id="editLaterBtn">Save &amp; return later</button>
        </div>
        <div class="status-region" role="status" aria-live="polite" id="statusRegion"></div>
      </section>
      <section id="resultsView" class="results-view" aria-labelledby="resultsHeading" hidden>
        <h2 id="resultsHeading" tabindex="-1">Assessment results</h2>
        <div class="card results-grid" id="scoreCards"></div>
        <div class="card" id="domainCard">
          <h3>Domain performance</h3>
          <table class="domain-table" aria-describedby="domainCard">
            <thead>
              <tr>
                <th scope="col">Domain</th>
                <th scope="col">Standard</th>
                <th scope="col">Score</th>
              </tr>
            </thead>
            <tbody id="domainTableBody"></tbody>
          </table>
        </div>
        <div class="card list-card" id="strengthsCard">
          <h3>Strength highlights</h3>
          <ul id="strengthsList"></ul>
        </div>
        <div class="card list-card" id="quickWinsCard">
          <h3>Quick wins</h3>
          <ul id="quickWinsList"></ul>
        </div>
        <div class="card list-card" id="next30Card">
          <h3>Next 30 days</h3>
          <ul id="next30List"></ul>
        </div>
        <div id="findingsContainer"></div>
        <div class="results-actions">
          <button type="button" class="btn btn-outline" id="editAnswersBtn">✏️ Edit answers</button>
          <button type="button" class="btn btn-outline" id="exportJsonBtn">📄 Export JSON</button>
          <button type="button" class="btn btn-outline" id="printBtn">🖨️ Print / Save PDF</button>
        </div>
        <p id="generatedAt" class="pill"></p>
      </section>
    </main>
  </div>
  <script type="module">
    const statusRegion = document.getElementById('statusRegion');
    const saveStateLabel = document.getElementById('saveStateLabel');

    (async () => {
      const moduleUrl = new URL('./complianceChecker.js', import.meta.url);
      try {
        const { createQuestionnaire, evaluateAnswers, generateReport, getMetadata } = await import(moduleUrl.href);

        const metadata = getMetadata();
        const questions = createQuestionnaire();
        if (!Array.isArray(questions) || questions.length === 0) {
          throw new Error('Questionnaire payload returned no entries.');
        }

        const questionMap = new Map(questions.map(q => [q.id, q]));
        const totalQuestions = questions.length;
        const appRoot = document.getElementById('appRoot');
        const form = document.getElementById('questionnaireForm');
        const questionnaireView = document.getElementById('questionnaireView');
        const resultsView = document.getElementById('resultsView');
        const progressCountEl = document.getElementById('progressCount');
        const progressPercentEl = document.getElementById('progressPercent');
        const progressBarEl = document.getElementById('progressBar');
        const domainNav = document.getElementById('domainNav');
        const saveProgressBtn = document.getElementById('saveProgressBtn');
        const clearProgressBtn = document.getElementById('clearProgressBtn');
        const editLaterBtn = document.getElementById('editLaterBtn');
        const themeToggleBtn = document.getElementById('themeToggle');
        const scoreCards = document.getElementById('scoreCards');
        const domainTableBody = document.getElementById('domainTableBody');
        const strengthsList = document.getElementById('strengthsList');
        const quickWinsList = document.getElementById('quickWinsList');
        const next30List = document.getElementById('next30List');
        const findingsContainer = document.getElementById('findingsContainer');
        const editAnswersBtn = document.getElementById('editAnswersBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const printBtn = document.getElementById('printBtn');
        const generatedAtEl = document.getElementById('generatedAt');
        const mainContent = document.getElementById('mainContent');

        document.getElementById('appTitle').textContent = `${metadata.appName}`;
        document.getElementById('disclaimerBadge').textContent = metadata.disclaimer;

        const LOCAL_STORAGE_KEY = 'crc-answers-v1';
        const THEME_STORAGE_KEY = 'crc-theme';

        const state = {
          answers: {},
          evaluation: null,
          report: null,
          view: 'questionnaire',
          dirty: false,
        };

        const domainTotals = {};
        questions.forEach(q => {
          domainTotals[q.domain] = (domainTotals[q.domain] || 0) + 1;
        });

        const domainIntros = {
          'Administrative Safeguards': 'Establish governance, policies, and workforce programs that underpin HIPAA security.',
          'Physical Safeguards': 'Protect physical spaces and media housing sensitive health information.',
          'Technical Safeguards': 'Apply technical controls to secure electronic protected health information (ePHI).',
          'Breach Notification': 'Prepare to detect, evaluate, and report potential data breaches promptly.',
          'Lawful Basis and Transparency': 'Demonstrate clear, lawful grounds and transparency for processing personal data.',
          'Data Subject Rights': 'Operationalize workflows that honor individuals’ rights over their personal data.',
          'DPIA and Records': 'Document processing activities and assess privacy risks for high-impact initiatives.',
          'Security of Processing': 'Ensure technical and organizational measures match the risk profile of your processing.',
          'Processors and DPAs': 'Manage vendors with enforceable agreements and due diligence.',
          'International Transfers': 'Control cross-border data flows with approved safeguards and documentation.'
        };

        const domainNavItems = new Map();
        const questionBlocks = new Map();
        const domainSections = new Map();

        function init() {
          loadTheme();
          loadSavedAnswers();
          renderNavigation();
          renderQuestionnaire();
          updateProgress();
          setupEventListeners();
        }

        function loadSavedAnswers() {
          try {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (stored) {
              const parsed = JSON.parse(stored);
              if (parsed && typeof parsed === 'object') {
                state.answers = parsed;
                state.dirty = false;
                if (saveStateLabel) {
                  saveStateLabel.textContent = 'Progress loaded';
                }
              }
            }
          } catch (error) {
            console.error('Unable to load saved answers', error);
          }
        }

        function loadTheme() {
          const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
          if (storedTheme === 'dark' || storedTheme === 'light') {
            appRoot.dataset.theme = storedTheme;
            themeToggleBtn.setAttribute('aria-pressed', storedTheme === 'dark');
          }
        }

        function setupEventListeners() {
          saveProgressBtn.addEventListener('click', () => {
            saveProgress();
            showStatus('Progress saved locally. You can return later to continue.');
          });

          editLaterBtn.addEventListener('click', () => {
            saveProgress();
            showStatus('Progress saved. You may close the window when ready.');
          });

          clearProgressBtn.addEventListener('click', () => {
            if (confirm('This will remove all answers and saved progress. Continue?')) {
              clearProgress();
              showStatus('All answers cleared.');
            }
          });

          form.addEventListener('submit', handleSubmit);
          themeToggleBtn.addEventListener('click', toggleTheme);
          editAnswersBtn.addEventListener('click', () => {
            switchView('questionnaire');
            mainContent.focus();
            showStatus('You can adjust your answers below.');
          });

          exportJsonBtn.addEventListener('click', exportReportJson);
          printBtn.addEventListener('click', () => window.print());

          window.addEventListener('beforeunload', (event) => {
            if (state.dirty) {
              event.preventDefault();
              event.returnValue = '';
            }
          });
        }

        function toggleTheme() {
          const nextTheme = appRoot.dataset.theme === 'dark' ? 'light' : 'dark';
          appRoot.dataset.theme = nextTheme;
          localStorage.setItem(THEME_STORAGE_KEY, nextTheme);
          themeToggleBtn.setAttribute('aria-pressed', nextTheme === 'dark');
          showStatus(`Switched to ${nextTheme} theme.`);
        }

        function renderNavigation() {
          domainNav.innerHTML = '';
          metadata.standards.forEach(standard => {
            const group = document.createElement('div');
            group.className = 'nav-group';
            const heading = document.createElement('h3');
            heading.textContent = standard;
            group.appendChild(heading);
            const list = document.createElement('ul');
            list.className = 'nav-items';
            const domains = metadata.domains[standard] || [];
            domains.forEach(domain => {
              const li = document.createElement('li');
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'nav-link';
              button.dataset.domain = domain;
              button.innerHTML = `<span>${domain}</span>`;
              const count = document.createElement('span');
              count.className = 'domain-count';
              count.textContent = `0 / ${domainTotals[domain] || 0}`;
              button.appendChild(count);
              button.addEventListener('click', () => {
                const target = document.querySelector(`[data-domain-section="${domain}"]`);
                if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  target.querySelector('fieldset')?.focus();
                }
              });
              li.appendChild(button);
              list.appendChild(li);
              domainNavItems.set(domain, { button, countEl: count });
            });
            group.appendChild(list);
            domainNav.appendChild(group);
          });
        }

        function renderQuestionnaire() {
          form.innerHTML = '';
          questionBlocks.clear();
          domainSections.clear();
          const fragment = document.createDocumentFragment();
          questions.forEach(question => {
            let section = domainSections.get(question.domain);
            if (!section) {
              section = document.createElement('section');
              section.className = 'domain-section';
              section.dataset.domainSection = question.domain;
              section.id = `domain-${question.domain.replace(/\s+/g, '-').toLowerCase()}`;
              const header = document.createElement('div');
              header.className = 'domain-header';
              const title = document.createElement('h2');
              title.textContent = `${question.domain}`;
              header.appendChild(title);
              const intro = document.createElement('p');
              intro.className = 'domain-intro';
              intro.textContent = domainIntros[question.domain] || '';
              header.appendChild(intro);
              section.appendChild(header);
              fragment.appendChild(section);
              domainSections.set(question.domain, section);
            }
            const block = createQuestionBlock(question);
            section.appendChild(block);
          });
          form.appendChild(fragment);
        }

        function createQuestionBlock(question) {
          const fieldset = document.createElement('fieldset');
          fieldset.className = 'question-block';
          fieldset.dataset.questionId = question.id;
          fieldset.tabIndex = -1;
          const legend = document.createElement('legend');
          const questionText = document.createElement('span');
          questionText.textContent = question.text;
          legend.appendChild(questionText);

          const infoWrapper = document.createElement('span');
          infoWrapper.className = 'info-wrapper';
          const tooltipId = `tooltip-${question.id}`;
          const infoButton = document.createElement('button');
          infoButton.type = 'button';
          infoButton.className = 'info-trigger';
          infoButton.setAttribute('aria-describedby', tooltipId);
          infoButton.setAttribute('aria-label', 'View guidance');
          infoButton.textContent = 'i';
          infoWrapper.appendChild(infoButton);
          const tooltip = document.createElement('span');
          tooltip.className = 'tooltip';
          tooltip.id = tooltipId;
          tooltip.role = 'tooltip';
          tooltip.textContent = question.guidance;
          infoWrapper.appendChild(tooltip);
          legend.appendChild(infoWrapper);
          fieldset.appendChild(legend);

          const optionsContainer = document.createElement('div');
          optionsContainer.className = 'options';
          const name = question.id;

          if (question.type === 'yes_no') {
            optionsContainer.appendChild(createRadioOption(name, 'true', 'Yes'));
            optionsContainer.appendChild(createRadioOption(name, 'false', 'No'));
          } else if (question.type === 'scale_0_2') {
            (question.choices || []).forEach(choice => {
              optionsContainer.appendChild(createRadioOption(name, String(choice.value), choice.label));
            });
          } else if (question.type === 'multiple') {
            (question.choices || []).forEach(choice => {
              optionsContainer.appendChild(createRadioOption(name, String(choice.value), choice.label));
            });
          }

          fieldset.appendChild(optionsContainer);
          const error = document.createElement('p');
          error.className = 'error-message';
          error.id = `${question.id}-error`;
          fieldset.appendChild(error);
          questionBlocks.set(question.id, { fieldset, error });

          return fieldset;
        }

        function createRadioOption(name, value, labelText) {
          const wrapper = document.createElement('div');
          wrapper.className = 'option';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = name;
          input.value = value;
          input.id = `${name}-${value}`;
          input.addEventListener('change', handleAnswerChange);
          const label = document.createElement('label');
          label.setAttribute('for', input.id);
          label.textContent = labelText;
          wrapper.appendChild(input);
          wrapper.appendChild(label);

          const existingAnswer = state.answers[name];
          if (existingAnswer !== undefined) {
            if (value === 'true' && existingAnswer === true) {
              input.checked = true;
            } else if (value === 'false' && existingAnswer === false) {
              input.checked = true;
            } else if (Number.isFinite(existingAnswer) && Number(value) === Number(existingAnswer)) {
              input.checked = true;
            } else if (typeof existingAnswer === 'string' && existingAnswer === value) {
              input.checked = true;
            }
          }

          return wrapper;
        }

        function handleAnswerChange(event) {
          const questionId = event.target.name;
          const question = questionMap.get(questionId);
          if (!question) return;

          let parsedValue;
          if (question.type === 'yes_no') {
            parsedValue = event.target.value === 'true';
          } else if (question.type === 'scale_0_2') {
            parsedValue = Number(event.target.value);
          } else {
            parsedValue = event.target.value;
          }

          state.answers[questionId] = parsedValue;
          state.dirty = true;
          if (saveStateLabel) {
            saveStateLabel.textContent = 'Unsaved changes';
          }
          hideError(questionId);
          updateProgress();
        }

        function hideError(questionId) {
          const block = questionBlocks.get(questionId);
          if (block) {
            block.fieldset.classList.remove('has-error');
            block.error.textContent = '';
          }
        }

        function showError(questionId, message) {
          const block = questionBlocks.get(questionId);
          if (block) {
            block.fieldset.classList.add('has-error');
            block.error.textContent = message;
          }
        }

        function updateProgress() {
          const answered = questions.filter(q => Object.prototype.hasOwnProperty.call(state.answers, q.id)).length;
          const percent = totalQuestions > 0 ? Math.round((answered / totalQuestions) * 100) : 0;
          progressCountEl.textContent = `${answered} / ${totalQuestions} answered`;
          progressPercentEl.textContent = `${percent}%`;
          progressBarEl.style.width = `${percent}%`;

          domainNavItems.forEach((item, domain) => {
            const total = domainTotals[domain] || 0;
            const answeredForDomain = questions.filter(q => q.domain === domain && Object.prototype.hasOwnProperty.call(state.answers, q.id)).length;
            item.countEl.textContent = `${answeredForDomain} / ${total}`;
            if (answeredForDomain === total && total > 0) {
              item.button.classList.add('complete');
            } else {
              item.button.classList.remove('complete');
            }
          });
        }

        function validateForm() {
          let isValid = true;
          questions.forEach(question => {
            const answered = Object.prototype.hasOwnProperty.call(state.answers, question.id);
            if (!answered) {
              isValid = false;
              showError(question.id, 'Please select an answer for this question.');
            }
          });
          if (!isValid) {
            showStatus('Please answer all questions before submitting.', true);
          }
          return isValid;
        }

        function handleSubmit(event) {
          event.preventDefault();
          if (!validateForm()) {
            const firstIncomplete = questions.find(q => !Object.prototype.hasOwnProperty.call(state.answers, q.id));
            if (firstIncomplete) {
              const block = questionBlocks.get(firstIncomplete.id);
              block?.fieldset.scrollIntoView({ behavior: 'smooth', block: 'center' });
              block?.fieldset.focus();
            }
            return;
          }

          const evaluation = evaluateAnswers(state.answers);
          const report = generateReport(evaluation);
          state.evaluation = evaluation;
          state.report = report;
          renderResults(report);
          switchView('results');
          state.dirty = true; // Encourage saving after reviewing results
          showStatus('Results generated. Review your findings below.');
          resultsView.querySelector('h2')?.focus({ preventScroll: false });
        }

        function renderResults(report) {
          scoreCards.innerHTML = '';
          const cardsData = [
            { label: 'Overall readiness', value: report.overallScore, accent: 'overall' },
            { label: 'HIPAA score', value: report.perStandardScores.HIPAA, accent: 'hipaa' },
            { label: 'GDPR score', value: report.perStandardScores.GDPR, accent: 'gdpr' }
          ];

          cardsData.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'card score-card';
            const svg = createDonutSVG(card.value);
            cardEl.appendChild(svg);
            const info = document.createElement('div');
            info.className = 'score-info';
            const valueEl = document.createElement('span');
            valueEl.className = 'score-value';
            valueEl.textContent = `${card.value.toFixed(1)}%`;
            const labelEl = document.createElement('span');
            labelEl.className = 'score-label';
            labelEl.textContent = card.label;
            info.appendChild(valueEl);
            info.appendChild(labelEl);
            const classificationEl = document.createElement('span');
            classificationEl.className = 'pill';
            if (card.label === 'Overall readiness') {
              classificationEl.textContent = `Classification: ${report.classification}`;
              info.appendChild(classificationEl);
            }
            cardEl.appendChild(info);
            scoreCards.appendChild(cardEl);
          });

          domainTableBody.innerHTML = '';
          report.perDomainScores.forEach(row => {
            const tr = document.createElement('tr');
            const domainCell = document.createElement('td');
            domainCell.textContent = row.domain;
            const standardCell = document.createElement('td');
            standardCell.textContent = row.standard;
            const scoreCell = document.createElement('td');
            const bar = document.createElement('div');
            bar.className = 'bar';
            const fill = document.createElement('span');
            fill.style.width = `${row.scorePercent.toFixed(1)}%`;
            fill.style.background = getScoreColor(row.scorePercent);
            bar.appendChild(fill);
            const scoreLabel = document.createElement('div');
            scoreLabel.textContent = `${row.scorePercent.toFixed(1)}%`;
            scoreLabel.style.fontWeight = '600';
            scoreLabel.style.marginTop = '0.3rem';
            scoreCell.appendChild(bar);
            scoreCell.appendChild(scoreLabel);
            tr.appendChild(domainCell);
            tr.appendChild(standardCell);
            tr.appendChild(scoreCell);
            domainTableBody.appendChild(tr);
          });

          renderList(strengthsList, report.strengths, 'No standout strengths recorded yet.');
          renderList(quickWinsList, report.quickWins, 'Add quick remediation ideas to see them here.');
          renderList(next30List, report.recommendedNext30Days, 'Define your next 30-day plan to populate this list.');
          renderFindings(report.findings);
          generatedAtEl.textContent = `Report generated: ${new Date(report.meta.generatedAtISO).toLocaleString()}`;
        }

        function renderList(container, items, emptyText) {
          container.innerHTML = '';
          if (!items || items.length === 0) {
            const li = document.createElement('li');
            li.textContent = emptyText;
            container.appendChild(li);
            return;
          }
          items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            container.appendChild(li);
          });
        }

        function renderFindings(findings) {
          findingsContainer.innerHTML = '';
          const severityOrder = ['High', 'Medium', 'Low'];
          if (!findings || findings.length === 0) {
            const card = document.createElement('div');
            card.className = 'card';
            const p = document.createElement('p');
            p.textContent = 'No findings generated. Great job!';
            card.appendChild(p);
            findingsContainer.appendChild(card);
            return;
          }
          severityOrder.forEach(level => {
            const levelFindings = findings.filter(f => f.severity === level);
            if (levelFindings.length === 0) return;
            const section = document.createElement('section');
            section.className = 'severity-section';
            const heading = document.createElement('h3');
            heading.className = 'severity-heading';
            const tag = document.createElement('span');
            tag.className = `severity-tag ${level.toLowerCase()}`;
            tag.textContent = level;
            heading.appendChild(tag);
            heading.append(` ${level} severity findings`);
            section.appendChild(heading);
            levelFindings.forEach(finding => {
              const details = document.createElement('details');
              details.className = 'finding';
              details.open = level === 'High';
              const summary = document.createElement('summary');
              summary.innerHTML = `<span>${finding.requirementSummary}</span>`;
              const meta = document.createElement('span');
              meta.className = 'finding-meta';
              meta.innerHTML = `<span>${finding.standard}</span><span>•</span><span>${finding.domain}</span>`;
              summary.appendChild(meta);
              details.appendChild(summary);
              const body = document.createElement('div');
              body.className = 'finding-body';
              const observed = document.createElement('p');
              observed.innerHTML = `<strong>Observed status:</strong> ${finding.observedStatus}`;
              const remediation = document.createElement('div');
              remediation.innerHTML = '<strong>Recommended remediation steps:</strong>';
              const remediationList = document.createElement('ul');
              finding.remediationSteps.forEach(step => {
                const li = document.createElement('li');
                li.textContent = step;
                remediationList.appendChild(li);
              });
              remediation.appendChild(remediationList);
              const evidence = document.createElement('div');
              evidence.innerHTML = '<strong>Evidence to provide:</strong>';
              const evidenceList = document.createElement('ul');
              finding.evidenceToProvide.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                evidenceList.appendChild(li);
              });
              evidence.appendChild(evidenceList);
              const citation = document.createElement('p');
              citation.innerHTML = `<strong>Citation:</strong> ${finding.citation}`;
              body.appendChild(observed);
              body.appendChild(remediation);
              body.appendChild(evidence);
              body.appendChild(citation);
              details.appendChild(body);
              section.appendChild(details);
            });
            findingsContainer.appendChild(section);
          });
        }

        function getScoreColor(percent) {
          if (percent >= 80) return 'var(--color-success)';
          if (percent >= 50) return 'var(--color-warning)';
          return 'var(--color-danger)';
        }

        function createDonutSVG(percent) {
          const radius = 48;
          const circumference = 2 * Math.PI * radius;
          const offset = circumference - (percent / 100) * circumference;
          const svgNS = 'http://www.w3.org/2000/svg';
          const svg = document.createElementNS(svgNS, 'svg');
          svg.setAttribute('viewBox', '0 0 120 120');
          svg.classList.add('donut');

          const circleBg = document.createElementNS(svgNS, 'circle');
          circleBg.setAttribute('cx', '60');
          circleBg.setAttribute('cy', '60');
          circleBg.setAttribute('r', String(radius));
          circleBg.setAttribute('fill', 'transparent');
          circleBg.setAttribute('stroke', 'rgba(82, 96, 109, 0.2)');
          circleBg.setAttribute('stroke-width', '12');
          svg.appendChild(circleBg);

          const circle = document.createElementNS(svgNS, 'circle');
          circle.setAttribute('cx', '60');
          circle.setAttribute('cy', '60');
          circle.setAttribute('r', String(radius));
          circle.setAttribute('fill', 'transparent');
          circle.setAttribute('stroke', getScoreColor(percent));
          circle.setAttribute('stroke-width', '12');
          circle.setAttribute('stroke-dasharray', `${circumference} ${circumference}`);
          circle.setAttribute('stroke-dashoffset', String(offset));
          circle.setAttribute('stroke-linecap', 'round');
          circle.setAttribute('transform', 'rotate(-90 60 60)');
          svg.appendChild(circle);

          const text = document.createElementNS(svgNS, 'text');
          text.setAttribute('x', '50%');
          text.setAttribute('y', '50%');
          text.setAttribute('dominant-baseline', 'middle');
          text.setAttribute('text-anchor', 'middle');
          text.textContent = `${percent.toFixed(0)}%`;
          svg.appendChild(text);

          return svg;
        }

        function switchView(view) {
          state.view = view;
          if (view === 'results') {
            questionnaireView.hidden = true;
            resultsView.hidden = false;
          } else {
            questionnaireView.hidden = false;
            resultsView.hidden = true;
          }
        }

        function saveProgress() {
          try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state.answers));
            state.dirty = false;
            if (saveStateLabel) {
              saveStateLabel.textContent = 'Progress saved';
            }
          } catch (error) {
            console.error('Unable to save progress', error);
            showStatus('Saving failed. Check browser storage permissions.', true);
          }
        }

        function clearProgress() {
          state.answers = {};
          state.evaluation = null;
          state.report = null;
          state.dirty = false;
          localStorage.removeItem(LOCAL_STORAGE_KEY);
          renderQuestionnaire();
          updateProgress();
          switchView('questionnaire');
          if (saveStateLabel) {
            saveStateLabel.textContent = 'Cleared';
          }
        }

        function exportReportJson() {
          if (!state.report) {
            showStatus('Generate results before exporting.', true);
            return;
          }
          const blob = new Blob([JSON.stringify(state.report, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `compliance-readiness-report-${Date.now()}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showStatus('Report downloaded as JSON.');
        }

        function showStatus(message, isError = false) {
          if (!statusRegion) return;
          statusRegion.textContent = message;
          statusRegion.style.color = isError ? 'var(--color-danger)' : 'var(--color-success)';
        }

        init();
      } catch (error) {
        console.error('Unable to initialize the Compliance Readiness Checker.', error);
        if (statusRegion) {
          statusRegion.textContent = 'Unable to load questionnaire data. Please refresh or confirm complianceChecker.js is deployed alongside index.html.';
          statusRegion.style.color = 'var(--color-danger)';
        }
        if (saveStateLabel) {
          saveStateLabel.textContent = 'Load failed';
        }
      }
    })();
  </script>
</body>
</html>